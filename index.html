<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calendar - æº«æ›¸å°å¹«æ‰‹</title>
  <style>
    :root { --bg:#f6fbff; --card:#ffffff; --line:#d9e7ff; --ink:#1f2a44; --accent:#4f7cff; --ok:#16a34a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: "PingFang TC","Noto Sans TC",sans-serif; color:var(--ink); background:linear-gradient(180deg,#eaf3ff,#f9fcff); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 18px; }
    h1 { margin:0 0 6px; font-size: 28px; }
    .sub { margin:0 0 16px; color:#4b5b80; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:14px; }
    button { border:1px solid var(--line); background:white; border-radius:10px; padding:8px 12px; cursor:pointer; }
    .month { font-weight: 700; color:var(--accent); }
    .grid { display:grid; grid-template-columns: repeat(7, minmax(0,1fr)); gap:10px; }
    .dow { text-align:center; font-weight:700; font-size:13px; color:#60709a; }
    .cell { background:var(--card); border:1px solid var(--line); border-radius:14px; min-height:210px; padding:8px; display:flex; flex-direction:column; }
    .muted { opacity:.45; }
    .date { font-weight:700; margin-bottom:6px; }
    .slot { border:1px dashed #d3def8; border-radius:10px; padding:6px; margin-bottom:6px; }
    .slot h4 { margin:0 0 4px; font-size:12px; color:#4e5f8a; }
    ul { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:4px; }
    li { display:flex; align-items:flex-start; gap:6px; font-size:13px; }
    input[type="checkbox"]{ margin-top:2px; }
    li.done span { text-decoration: line-through; color:#7d8cb0; }
    .add { display:flex; gap:4px; margin-top:4px; }
    .add input { width:100%; border:1px solid #d7e3ff; border-radius:8px; padding:5px 6px; font-size:12px; }
    .add button { padding:5px 8px; font-size:12px; background:#eef4ff; }
    .tip { font-size:12px; color:#60709a; margin-top:10px; }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(0,1fr));} .dow{display:none;} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ“š Calendar æº«æ›¸å°å¹«æ‰‹</h1>
    <p class="sub">ä¸€æ ¼ä¸€æ ¼æ’æ¯æ—¥æº«ç¿’ï¼ŒAM / PM checklist åšå®Œå°±å‰” âœ…</p>
    <div class="toolbar">
      <button id="prev">â† ä¸Šå€‹æœˆ</button>
      <div class="month" id="monthLabel"></div>
      <button id="next">ä¸‹å€‹æœˆ â†’</button>
      <button id="todayBtn">ä»Šæ—¥</button>
      <button id="saveBtn" disabled>æ‰‹å‹•å„²å­˜</button>
    </div>
    <div class="grid" id="weekHeader"></div>
    <div class="grid" id="calendar"></div>
    <p class="tip" id="syncTip">è³‡æ–™ä»¥ Firebase é›²ç«¯ç‚ºä¸»ï¼ˆè·¨æ‰‹æ©Ÿå…±ç”¨åŒä¸€ä»½ï¼‰ã€‚</p>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

async function loadFirebaseConfig(){
  const res = await fetch("/api/firebase-config", { cache: "no-store" });
  if(!res.ok) throw new Error("æœªèƒ½è¼‰å…¥ Firebase è¨­å®š");
  const cfg = await res.json();
  if(!cfg?.apiKey) throw new Error("Firebase è¨­å®šä¸å®Œæ•´");
  return cfg;
}

const week = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
const weekHeader = document.getElementById('weekHeader');
const calendar = document.getElementById('calendar');
const monthLabel = document.getElementById('monthLabel');
const syncTip = document.getElementById('syncTip');
let store = {};
let cursor = new Date();
cursor.setDate(1);
let cloudDocRef;
let cloudReady = false;
let saveTimer;

week.forEach(d=>{ const el=document.createElement('div'); el.className='dow'; el.textContent='æ˜ŸæœŸ'+d; weekHeader.appendChild(el); });

function pad(n){ return String(n).padStart(2,'0'); }
function k(date,slot){ return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}-${slot}`; }

function saveLocal(){}

async function saveCloudNow(){
  if(!cloudReady) throw new Error('Firebase å°šæœªé€£ç·šå®Œæˆ');
  await setDoc(cloudDocRef, {
    updatedAt: serverTimestamp(),
    data: store
  }, { merge: true });
}

function scheduleCloudSave(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async ()=>{
    try {
      await saveCloudNow();
      syncTip.textContent = 'âœ… å·²åŒæ­¥åˆ° Firebase é›²ç«¯';
    } catch {
      syncTip.textContent = 'âš ï¸ é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œå·²ä¿å­˜åœ¨æœ¬æ©Ÿ';
    }
  }, 450);
}

function save(){
  saveLocal();
  scheduleCloudSave();
}

function addTask(key, text){
  if(!text.trim()) return;
  if(!store[key]) store[key]=[];
  store[key].push({ text:text.trim(), done:false });
  save(); render();
}
function toggleTask(key, idx){
  store[key][idx].done = !store[key][idx].done;
  save(); render();
}

function slotBlock(dateObj, slot){
  const key = k(dateObj, slot);
  const box = document.createElement('div');
  box.className = 'slot';
  const title = document.createElement('h4');
  title.textContent = slot;
  box.appendChild(title);

  const ul = document.createElement('ul');
  (store[key] || []).forEach((item, i)=>{
    const li = document.createElement('li');
    if(item.done) li.className='done';
    const cb = document.createElement('input');
    cb.type = 'checkbox'; cb.checked = !!item.done;
    cb.addEventListener('change', ()=>toggleTask(key,i));
    const span = document.createElement('span'); span.textContent = item.text;
    li.append(cb, span); ul.appendChild(li);
  });
  box.appendChild(ul);

  const add = document.createElement('div'); add.className='add';
  const inp = document.createElement('input'); inp.placeholder='ä¾‹å¦‚ï¼šä¸­æ–‡èª²æ–‡ç¬¬3èª²';
  const btn = document.createElement('button'); btn.textContent='ï¼‹';
  btn.addEventListener('click', ()=>addTask(key, inp.value));
  inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') addTask(key, inp.value); });
  add.append(inp, btn); box.appendChild(add);
  return box;
}

function render(){
  calendar.innerHTML = '';
  const y = cursor.getFullYear();
  const m = cursor.getMonth();
  monthLabel.textContent = `${y} å¹´ ${m+1} æœˆ`;

  const first = new Date(y,m,1);
  const start = new Date(first); start.setDate(1-first.getDay());

  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const cell = document.createElement('div');
    cell.className = 'cell' + (d.getMonth()!==m ? ' muted':'');
    const dt = document.createElement('div'); dt.className='date'; dt.textContent=`${d.getMonth()+1}/${d.getDate()} (${week[d.getDay()]})`;
    cell.appendChild(dt);
    cell.appendChild(slotBlock(d,'AM'));
    cell.appendChild(slotBlock(d,'PM'));
    calendar.appendChild(cell);
  }
}

document.getElementById('prev').onclick = ()=>{ cursor.setMonth(cursor.getMonth()-1); render(); };
document.getElementById('next').onclick = ()=>{ cursor.setMonth(cursor.getMonth()+1); render(); };
document.getElementById('todayBtn').onclick = ()=>{ cursor = new Date(); cursor.setDate(1); render(); };


document.getElementById('saveBtn').onclick = async ()=>{
  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  const prev = btn.textContent;
  btn.textContent = 'å„²å­˜ä¸­...';
  try {
    await saveCloudNow();
    syncTip.textContent = 'âœ… æ‰‹å‹•å„²å­˜æˆåŠŸï¼ˆFirebaseï¼‰';
    alert('âœ… å·²æˆåŠŸå„²å­˜åˆ° Firebase');
  } catch (err) {
    console.error(err);
    syncTip.textContent = 'âŒ å„²å­˜å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firestore Rules';
    alert('âŒ å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firestore Rules');
  } finally {
    btn.disabled = false;
    btn.textContent = prev;
  }
};

async function initFirebaseSync(){
  try {
    const firebaseConfig = await loadFirebaseConfig();
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await signInAnonymously(auth);
    cloudDocRef = doc(db, 'calendars', 'kids-study-main');

    const snap = await getDoc(cloudDocRef);
    if (snap.exists() && snap.data()?.data) {
      store = snap.data().data;
      saveLocal();
      syncTip.textContent = 'â˜ï¸ å·²è¼‰å…¥ Firebase é›²ç«¯è³‡æ–™';
    } else {
      cloudReady = true;
      await saveCloudNow();
      syncTip.textContent = 'â˜ï¸ Firebase å·²é€£æ¥ï¼ˆé¦–æ¬¡å»ºç«‹ï¼‰';
    }

    cloudReady = true;
    document.getElementById('saveBtn').disabled = false;
    render();
  } catch (err) {
    console.error(err);
    syncTip.textContent = 'âš ï¸ Firebase é€£æ¥å¤±æ•—ï¼Œæœªèƒ½é›²ç«¯åŒæ­¥';
    const b = document.getElementById('saveBtn'); b.disabled = true; b.textContent = 'æ‰‹å‹•å„²å­˜ï¼ˆæœªé€£ç·šï¼‰';
    render();
  }
}

initFirebaseSync();
</script>
</body>
</html>
